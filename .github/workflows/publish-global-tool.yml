name: Publish Global Tool

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      nuget-api-key:
        description: "Optional NuGet.org API key (paste only when manually dispatching)"
        required: false
        default: ""

permissions:
  contents: read
  packages: write
  pages: write
  id-token: write

jobs:
  build-and-publish:
    name: Build and publish tool package
    runs-on: ubuntu-latest
    env:
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: 1
      HAS_NUGET_API_KEY: ${{ secrets.NUGET_API_KEY != '' && 'true' || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup .NET 10 Preview SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
          dotnet-quality: preview

      - name: Restore dependencies
        run: dotnet restore src/Xtraq.csproj -p:PublishReadyToRun=false

      - name: Pack global tool (Release)
        run: dotnet pack src/Xtraq.csproj --configuration Release --no-restore -p:PublishSingleFile=false -p:PublishReadyToRun=false --output artifacts/nuget

      - name: Publish to GitHub Packages feed
        env:
          GITHUB_FEED: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
        run: |
          dotnet nuget push artifacts/nuget/*.nupkg --api-key "${{ github.token }}" --source "$GITHUB_FEED" --skip-duplicate

      - name: Publish to NuGet.org
        if: ${{ env.HAS_NUGET_API_KEY == 'true' }}
        run: |
          dotnet nuget push artifacts/nuget/*.nupkg --api-key '${{ secrets.NUGET_API_KEY }}' --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Publish to NuGet.org (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.nuget-api-key != '' }}
        run: |
          dotnet nuget push artifacts/nuget/*.nupkg --api-key '${{ inputs.nuget-api-key }}' --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Upload NuGet artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xtraq-global-tool
          path: artifacts/nuget
          overwrite: true
          if-no-files-found: error

  docs-site:
    name: Build and deploy docs site (inactive)
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/v') && false }}
    env:
      NODE_ENV: production
    defaults:
      run:
        working-directory: docs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate static site
        run: npm run generate

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.output/public

      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v4

